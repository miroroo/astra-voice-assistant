import random
import re
from .module import Module


class RandomModule(Module):
    """ÐœÐ¾Ð´ÑƒÐ»ÑŒ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ñ… Ñ‡Ð¸ÑÐµÐ» Ð¸ Ð±Ñ€Ð¾ÑÐºÐ¾Ð² ÐºÑƒÐ±Ð¸ÐºÐ¾Ð²."""
    
    def __init__(self, astra_manager):
        super().__init__(astra_manager)
        
        # Ð¡Ð»Ð¾Ð²Ð°Ñ€ÑŒ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð° Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… Ñ‡Ð¸ÑÐµÐ» Ð² Ñ†Ð¸Ñ„Ñ€Ñ‹
        self.number_dict = {
            'Ð½Ð¾Ð»ÑŒ': 0, 'Ð½ÑƒÐ»ÑŒ': 0,
            'Ð¾Ð´Ð¸Ð½': 1, 'Ð¾Ð´Ð½Ð°': 1, 'Ð¾Ð´Ð½Ñƒ': 1, 'Ð¾Ð´Ð½Ð¾Ð³Ð¾': 1,
            'Ð´Ð²Ð°': 2, 'Ð´Ð²Ðµ': 2, 'Ð´Ð²ÑƒÑ…': 2,
            'Ñ‚Ñ€Ð¸': 3, 'Ñ‚Ñ€Ñ‘Ñ…': 3, 'Ñ‡ÐµÑ‚Ñ‹Ñ€Ðµ': 4, 'Ñ‡ÐµÑ‚Ñ‹Ñ€Ñ‘Ñ…': 4, 'Ð¿ÑÑ‚ÑŒ': 5, 'Ð¿ÑÑ‚Ð¸': 5, 
            'ÑˆÐµÑÑ‚ÑŒ': 6, 'ÑÐµÐ¼ÑŒ': 7, 'Ð²Ð¾ÑÐµÐ¼ÑŒ': 8, 'Ð´ÐµÐ²ÑÑ‚ÑŒ': 9,
            'Ð´ÐµÑÑÑ‚ÑŒ': 10, 'Ð¾Ð´Ð¸Ð½Ð½Ð°Ð´Ñ†Ð°Ñ‚ÑŒ': 11, 'Ð´Ð²ÐµÐ½Ð°Ð´Ñ†Ð°Ñ‚ÑŒ': 12,
            'Ñ‚Ñ€Ð¸Ð½Ð°Ð´Ñ†Ð°Ñ‚ÑŒ': 13, 'Ñ‡ÐµÑ‚Ñ‹Ñ€Ð½Ð°Ð´Ñ†Ð°Ñ‚ÑŒ': 14, 'Ð¿ÑÑ‚Ð½Ð°Ð´Ñ†Ð°Ñ‚ÑŒ': 15,
            'ÑˆÐµÑÑ‚Ð½Ð°Ð´Ñ†Ð°Ñ‚ÑŒ': 16, 'ÑÐµÐ¼Ð½Ð°Ð´Ñ†Ð°Ñ‚ÑŒ': 17, 'Ð²Ð¾ÑÐµÐ¼Ð½Ð°Ð´Ñ†Ð°Ñ‚ÑŒ': 18,
            'Ð´ÐµÐ²ÑÑ‚Ð½Ð°Ð´Ñ†Ð°Ñ‚ÑŒ': 19, 
            'Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ': 20, 'Ñ‚Ñ€Ð¸Ð´Ñ†Ð°Ñ‚ÑŒ': 30, 'ÑÐ¾Ñ€Ð¾Ðº': 40, 'Ð¿ÑÑ‚ÑŒÐ´ÐµÑÑÑ‚': 50,
            'ÑˆÐµÑÑ‚ÑŒÐ´ÐµÑÑÑ‚': 60, 'ÑÐµÐ¼ÑŒÐ´ÐµÑÑÑ‚': 70, 'Ð²Ð¾ÑÐµÐ¼ÑŒÐ´ÐµÑÑÑ‚': 80, 'Ð´ÐµÐ²ÑÐ½Ð¾ÑÑ‚Ð¾': 90,
            'ÑÑ‚Ð¾': 100, 'Ð´Ð²ÐµÑÑ‚Ð¸': 200, 'Ñ‚Ñ€Ð¸ÑÑ‚Ð°': 300, 'Ñ‡ÐµÑ‚Ñ‹Ñ€ÐµÑÑ‚Ð°': 400,
            'Ð¿ÑÑ‚ÑŒÑÐ¾Ñ‚': 500, 'ÑˆÐµÑÑ‚ÑŒÑÐ¾Ñ‚': 600, 'ÑÐµÐ¼ÑŒÑÐ¾Ñ‚': 700, 'Ð²Ð¾ÑÐµÐ¼ÑŒÑÐ¾Ñ‚': 800,
            'Ð´ÐµÐ²ÑÑ‚ÑŒÑÐ¾Ñ‚': 900, 'Ñ‚Ñ‹ÑÑÑ‡Ð°': 1000,
            
            # Ð¡Ð¾ÑÑ‚Ð°Ð²Ð½Ñ‹Ðµ Ñ‡Ð¸ÑÐ»Ð° (Ð´Ð²Ð° ÑÐ»Ð¾Ð²Ð°)
            'Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ Ð¾Ð´Ð¸Ð½': 21, 'Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ Ð¾Ð´Ð½Ð°': 21, 'Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ Ð¾Ð´Ð½Ñƒ': 21,
            'Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ Ð´Ð²Ð°': 22, 'Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ Ð´Ð²Ðµ': 22,
            'Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ Ñ‚Ñ€Ð¸': 23, 'Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ Ñ‡ÐµÑ‚Ñ‹Ñ€Ðµ': 24, 'Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ Ð¿ÑÑ‚ÑŒ': 25,
            'Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ ÑˆÐµÑÑ‚ÑŒ': 26, 'Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ ÑÐµÐ¼ÑŒ': 27, 'Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ Ð²Ð¾ÑÐµÐ¼ÑŒ': 28, 'Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ Ð´ÐµÐ²ÑÑ‚ÑŒ': 29,
            'Ñ‚Ñ€Ð¸Ð´Ñ†Ð°Ñ‚ÑŒ Ð¾Ð´Ð¸Ð½': 31, 'Ñ‚Ñ€Ð¸Ð´Ñ†Ð°Ñ‚ÑŒ Ð¾Ð´Ð½Ð°': 31, 'Ñ‚Ñ€Ð¸Ð´Ñ†Ð°Ñ‚ÑŒ Ð¾Ð´Ð½Ñƒ': 31,
            'Ñ‚Ñ€Ð¸Ð´Ñ†Ð°Ñ‚ÑŒ Ð´Ð²Ð°': 32, 'Ñ‚Ñ€Ð¸Ð´Ñ†Ð°Ñ‚ÑŒ Ð´Ð²Ðµ': 32,
            'Ñ‚Ñ€Ð¸Ð´Ñ†Ð°Ñ‚ÑŒ Ñ‚Ñ€Ð¸': 33, 'Ñ‚Ñ€Ð¸Ð´Ñ†Ð°Ñ‚ÑŒ Ñ‡ÐµÑ‚Ñ‹Ñ€Ðµ': 34, 'Ñ‚Ñ€Ð¸Ð´Ñ†Ð°Ñ‚ÑŒ Ð¿ÑÑ‚ÑŒ': 35,
            'Ñ‚Ñ€Ð¸Ð´Ñ†Ð°Ñ‚ÑŒ ÑˆÐµÑÑ‚ÑŒ': 36, 'Ñ‚Ñ€Ð¸Ð´Ñ†Ð°Ñ‚ÑŒ ÑÐµÐ¼ÑŒ': 37, 'Ñ‚Ñ€Ð¸Ð´Ñ†Ð°Ñ‚ÑŒ Ð²Ð¾ÑÐµÐ¼ÑŒ': 38, 'Ñ‚Ñ€Ð¸Ð´Ñ†Ð°Ñ‚ÑŒ Ð´ÐµÐ²ÑÑ‚ÑŒ': 39,
            'ÑÐ¾Ñ€Ð¾Ðº Ð¾Ð´Ð¸Ð½': 41, 'ÑÐ¾Ñ€Ð¾Ðº Ð¾Ð´Ð½Ð°': 41, 'ÑÐ¾Ñ€Ð¾Ðº Ð¾Ð´Ð½Ñƒ': 41,
            'ÑÐ¾Ñ€Ð¾Ðº Ð´Ð²Ð°': 42, 'ÑÐ¾Ñ€Ð¾Ðº Ð´Ð²Ðµ': 42,
            'ÑÐ¾Ñ€Ð¾Ðº Ñ‚Ñ€Ð¸': 43, 'ÑÐ¾Ñ€Ð¾Ðº Ñ‡ÐµÑ‚Ñ‹Ñ€Ðµ': 44, 'ÑÐ¾Ñ€Ð¾Ðº Ð¿ÑÑ‚ÑŒ': 45,
            'ÑÐ¾Ñ€Ð¾Ðº ÑˆÐµÑÑ‚ÑŒ': 46, 'ÑÐ¾Ñ€Ð¾Ðº ÑÐµÐ¼ÑŒ': 47, 'ÑÐ¾Ñ€Ð¾Ðº Ð²Ð¾ÑÐµÐ¼ÑŒ': 48, 'ÑÐ¾Ñ€Ð¾Ðº Ð´ÐµÐ²ÑÑ‚ÑŒ': 49,
            'Ð¿ÑÑ‚ÑŒÐ´ÐµÑÑÑ‚ Ð¾Ð´Ð¸Ð½': 51, 'Ð¿ÑÑ‚ÑŒÐ´ÐµÑÑÑ‚ Ð¾Ð´Ð½Ð°': 51, 'Ð¿ÑÑ‚ÑŒÐ´ÐµÑÑÑ‚ Ð¾Ð´Ð½Ñƒ': 51,
            'Ð¿ÑÑ‚ÑŒÐ´ÐµÑÑÑ‚ Ð´Ð²Ð°': 52, 'Ð¿ÑÑ‚ÑŒÐ´ÐµÑÑÑ‚ Ð´Ð²Ðµ': 52,
            'Ð¿ÑÑ‚ÑŒÐ´ÐµÑÑÑ‚ Ñ‚Ñ€Ð¸': 53, 'Ð¿ÑÑ‚ÑŒÐ´ÐµÑÑÑ‚ Ñ‡ÐµÑ‚Ñ‹Ñ€Ðµ': 54, 'Ð¿ÑÑ‚ÑŒÐ´ÐµÑÑÑ‚ Ð¿ÑÑ‚ÑŒ': 55,
            'Ð¿ÑÑ‚ÑŒÐ´ÐµÑÑÑ‚ ÑˆÐµÑÑ‚ÑŒ': 56, 'Ð¿ÑÑ‚ÑŒÐ´ÐµÑÑÑ‚ ÑÐµÐ¼ÑŒ': 57, 'Ð¿ÑÑ‚ÑŒÐ´ÐµÑÑÑ‚ Ð²Ð¾ÑÐµÐ¼ÑŒ': 58, 'Ð¿ÑÑ‚ÑŒÐ´ÐµÑÑÑ‚ Ð´ÐµÐ²ÑÑ‚ÑŒ': 59,
            
            # Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ
            'Ð¿Ð¾Ð»Ñ‡Ð°ÑÐ°': 30, 'Ð¿Ð¾Ð»Ñ‚Ð¾Ñ€Ð°': 90, 'ÑÐ¾Ñ‚Ð½Ñ': 100, 'ÑÐ¾Ñ‚Ð½ÑŽ': 100,
            'Ð¿Ð°Ñ€Ð°': 2, 'Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾': 3, 'Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾': 3, 'Ð¼Ð½Ð¾Ð³Ð¾': 10,
        }
        
        # ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð° Ð´Ð»Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
        self.random_keywords = [
            # ÐšÑƒÐ±Ð¸ÐºÐ¸
            'ÐºÑƒÐ±Ð¸Ðº', 'ÐºÐ¾ÑÑ‚ÑŒ', 'ÐºÐ¾ÑÑ‚Ð¸', 'Ð´Ð°Ð¹Ñ', 'Ð±Ñ€Ð¾ÑÑŒ ÐºÑƒÐ±Ð¸Ðº', 'ÐºÐ¸Ð½ÑŒ ÐºÑƒÐ±Ð¸Ðº',
            'Ð±Ñ€Ð¾ÑÑŒ ÐºÐ¾ÑÑ‚Ð¸', 'ÐºÐ¸Ð½ÑŒ ÐºÐ¾ÑÑ‚Ð¸', 'Ð±Ñ€Ð¾ÑÑŒ Ð´Ð°Ð¹Ñ', 'ÐºÐ¸Ð½ÑŒ Ð´Ð°Ð¹Ñ',
            'Ð±Ñ€Ð¾ÑÑŒ ÐºÑƒÐ±Ð¸ÐºÐ¸', 'ÐºÐ¸Ð½ÑŒ ÐºÑƒÐ±Ð¸ÐºÐ¸', 'ÐºÐ¸Ð½ÑƒÑ‚ÑŒ', 'Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ', 'Ð¸Ð³Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹',
            
            # Ð¡Ð»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ðµ Ñ‡Ð¸ÑÐ»Ð°
            'ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾', 'Ñ€Ð°Ð½Ð´Ð¾Ð¼Ð½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾', 'Ñ€Ð°Ð½Ð´Ð¾Ð¼', 'ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ðµ',
            'Ð²Ñ‹Ð±ÐµÑ€Ð¸ Ñ‡Ð¸ÑÐ»Ð¾', 'Ð·Ð°Ð³Ð°Ð´Ð°Ð¹ Ñ‡Ð¸ÑÐ»Ð¾', 'Ñ‡Ð¸ÑÐ»Ð¾ Ð¾Ñ‚', 'Ñ€Ð°Ð½Ð´Ð¾Ð¼ Ð¾Ñ‚',
            'Ð¾Ñ‚ Ð´Ð¾', 'Ð¾Ñ‚Ñ‡Ð¸ÑÐ»Ð¾', 'ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ðµ Ð¾Ñ‚', 'Ð´Ð°Ð¹ Ñ‡Ð¸ÑÐ»Ð¾',
            'Ð½Ð°Ð·Ð¾Ð²Ð¸ Ñ‡Ð¸ÑÐ»Ð¾', 'ÑƒÐºÐ°Ð¶Ð¸ Ñ‡Ð¸ÑÐ»Ð¾', 'ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐ¹ Ñ‡Ð¸ÑÐ»Ð¾',
            'Ð¿Ñ€Ð¸Ð´ÑƒÐ¼Ð°Ð¹ Ñ‡Ð¸ÑÐ»Ð¾', 'Ð¿Ð¾Ð´ÑÐºÐ°Ð¶Ð¸ Ñ‡Ð¸ÑÐ»Ð¾', 'Ð·Ð°Ð³Ð°Ð´Ð°Ð¹'
        ]
        
        # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð¾Ð² Astra
        self.module_name = self.get_name()
        self.state_manager = self.astra_manager.get_state_manager()
    
    async def can_handle(self, command: str) -> bool:
        """
        ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚, Ð¼Ð¾Ð¶ÐµÑ‚ Ð»Ð¸ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ
        
        Args:
            command: Ð¢ÐµÐºÑÑ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
            
        Returns:
            bool: True ÐµÑÐ»Ð¸ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð°ÑŽÑ‚ÑÑ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð°, Ð¸Ð½Ð°Ñ‡Ðµ False
        """
        if not command or not isinstance(command, str):
            return False
        
        # ÐŸÑ€Ð¸Ð²Ð¾Ð´Ð¸Ð¼ Ðº Ð½Ð¸Ð¶Ð½ÐµÐ¼Ñƒ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ñƒ
        cmd = command.lower().strip()
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð°
        for keyword in self.random_keywords:
            if keyword in cmd:
                # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð¼Ð¾Ð´ÑƒÐ»Ñ
                self.state_manager.set_active_context(
                    self.module_name,
                    priority=10,  # Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚ Ð´Ð»Ñ Ñ€Ð°Ð·Ð²Ð»ÐµÐºÐ°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÐºÐ¾Ð¼Ð°Ð½Ð´
                    context_type="random",
                    timeout_seconds=60  # 1 Ð¼Ð¸Ð½ÑƒÑ‚Ð°
                )
                return True
        
        return False
    
    async def execute(self, command: str) -> str:
        """
        ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚
        
        Args:
            command: Ð¢ÐµÐºÑÑ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
            
        Returns:
            str: ÐžÑ‚Ð²ÐµÑ‚ Ð¼Ð¾Ð´ÑƒÐ»Ñ Ð½Ð° ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ
        """
        # ÐŸÑ€Ð¸Ð²Ð¾Ð´Ð¸Ð¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ Ðº Ð½Ð¸Ð¶Ð½ÐµÐ¼Ñƒ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ñƒ Ð´Ð»Ñ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ
        cmd = command.lower()
        
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚Ð¸Ð¿ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
        if any(word in cmd for word in ['ÐºÑƒÐ±Ð¸Ðº', 'ÐºÐ¾ÑÑ‚ÑŒ', 'ÐºÐ¾ÑÑ‚Ð¸', 'Ð´Ð°Ð¹Ñ']):
            return await self._roll_dice(command)
        else:
            return await self._random_number(command)
    
    async def _roll_dice(self, command: str) -> str:
        """
        Ð‘Ñ€Ð¾ÑÐ°ÐµÑ‚ ÐºÑƒÐ±Ð¸ÐºÐ¸
        
        Args:
            command: Ð¢ÐµÐºÑÑ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
            
        Returns:
            str: Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð±Ñ€Ð¾ÑÐºÐ°
        """
        # ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð±Ñ€Ð¾ÑÐ°ÐµÐ¼ 1 ÐºÑƒÐ±Ð¸Ðº
        dice_count = 1
        
        # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ñ‡Ð¸ÑÐ»Ð¾ Ð¸Ð· Ñ‚ÐµÐºÑÑ‚Ð°
        number = self._extract_number_from_text(command)
        
        if number is not None:
            dice_count = number
        else:
            # Ð•ÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸ Ñ‡Ð¸ÑÐ»Ð¾, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑÐ»Ð¾Ð²Ð°
            cmd = command.lower()
            if any(word in cmd for word in ['Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾', 'Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾', 'Ð¿Ð°Ñ€Ð°']):
                dice_count = 2
            elif any(word in cmd for word in ['Ð¼Ð½Ð¾Ð³Ð¾', 'ÐºÑƒÐ±Ð¸ÐºÐ¸', 'ÐºÐ¾ÑÑ‚Ð¸', 'Ð²ÑÐµ']):
                dice_count = 5
            elif 'ÐºÑƒÐ±Ð¸Ðº' in cmd or 'ÐºÐ¾ÑÑ‚ÑŒ' in cmd:
                dice_count = 1
        
        # ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·ÑƒÐ¼Ð½Ñ‹Ð¼Ð¸ Ð¿Ñ€ÐµÐ´ÐµÐ»Ð°Ð¼Ð¸
        dice_count = max(1, min(dice_count, 20))
        
        # Ð‘Ñ€Ð¾ÑÐ°ÐµÐ¼ ÐºÑƒÐ±Ð¸ÐºÐ¸
        results = [random.randint(1, 6) for _ in range(dice_count)]
        
        # Ð—Ð²ÑƒÐº Ð±Ñ€Ð¾ÑÐºÐ°
        sound = random.choice(["*Ð±Ñ€Ð¾ÑÐ°ÑŽ ÐºÑƒÐ±Ð¸Ðº*", "*ÐºÐ¸Ð´Ð°ÑŽ ÐºÐ¾ÑÑ‚Ð¸*", "*ÐºÑƒÐ±Ð¸ÐºÐ¸ Ð»ÐµÑ‚ÑÑ‚*", "*Ð¶ÑƒÐ¶Ð¶Ð°Ð½Ð¸Ðµ ÐºÑƒÐ±Ð¸ÐºÐ¾Ð²*"])
        
        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÑƒÐ±Ð¸ÐºÐ¾Ð²
        if dice_count == 1:
            response = random.choice([
                f"{sound} Ð’Ñ‹Ð¿Ð°Ð»Ð¾ {results[0]}! ðŸŽ²",
                f"{sound} ÐÐ° ÐºÑƒÐ±Ð¸ÐºÐµ {results[0]}!",
                f"{sound} Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚: {results[0]}! ðŸŽ²",
                f"{sound} Ð’Ð°Ð¼ Ð²Ñ‹Ð¿Ð°Ð»Ð¾ {results[0]}!"
            ])
        else:
            results_str = ', '.join(map(str, results))
            total = sum(results)
            response = random.choice([
                f"{sound} Ð‘Ñ€Ð¾ÑÐ°ÑŽ {dice_count} ÐºÑƒÐ±Ð¸ÐºÐ¾Ð²... Ð’Ñ‹Ð¿Ð°Ð»Ð¾: {results_str}. Ð¡ÑƒÐ¼Ð¼Ð°: {total} ðŸŽ²ðŸŽ²",
                f"{sound} Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ {dice_count} ÐºÑƒÐ±Ð¸ÐºÐ¾Ð²: {results_str}. Ð’ÑÐµÐ³Ð¾: {total}",
                f"{sound} ÐšÐ¸Ð´Ð°ÑŽ {dice_count} ÐºÐ¾ÑÑ‚ÐµÐ¹... {results_str}. ÐžÐ±Ñ‰Ð¸Ð¹ ÑÑ‡ÐµÑ‚: {total}",
                f"{sound} {dice_count} ÐºÑƒÐ±Ð¸ÐºÐ¾Ð² Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚: {results_str}. Ð’ ÑÑƒÐ¼Ð¼Ðµ: {total} ðŸŽ²"
            ])
        
        return response
    
    async def _random_number(self, command: str) -> str:
        """
        Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾
        
        Args:
            command: Ð¢ÐµÐºÑÑ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
            
        Returns:
            str: Ð¡Ð»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾ Ñ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸ÐµÐ¼
        """
        # ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð¾Ñ‚ 1 Ð´Ð¾ 100
        min_val = 1
        max_val = 100
        
        cmd = command.lower()
        
        # Ð˜Ñ‰ÐµÐ¼ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ "Ð¾Ñ‚ X Ð´Ð¾ Y"
        from_to_match = re.search(r'Ð¾Ñ‚\s+([Ð°-ÑÑ‘\d\s]+?)\s+Ð´Ð¾\s+([Ð°-ÑÑ‘\d\s]+)', cmd)
        
        if from_to_match:
            # ÐÐ°ÑˆÐ»Ð¸ ÐºÐ¾Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸ÑŽ "Ð¾Ñ‚ X Ð´Ð¾ Y"
            from_text = from_to_match.group(1).strip()
            to_text = from_to_match.group(2).strip()
            
            min_val = self._extract_number_from_text(from_text, default=1)
            max_val = self._extract_number_from_text(to_text, default=100)
            
            # Ð•ÑÐ»Ð¸ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐ¸Ñ‚ÑŒ, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð½Ð°Ð¹Ñ‚Ð¸ Ñ‡Ð¸ÑÐ»Ð° Ð² Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¼ÐµÑÑ‚Ð°Ñ…
            if min_val is None or max_val is None:
                # Ð˜Ñ‰ÐµÐ¼ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ‡Ð¸ÑÐ»Ð° Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ
                all_numbers = self._extract_all_numbers_from_text(cmd)
                if len(all_numbers) >= 2:
                    min_val = all_numbers[0]
                    max_val = all_numbers[1]
        
        else:
            # Ð˜Ñ‰ÐµÐ¼ "Ð´Ð¾ X"
            to_match = re.search(r'Ð´Ð¾\s+([Ð°-ÑÑ‘\d\s]+)', cmd)
            if to_match:
                to_text = to_match.group(1).strip()
                max_val = self._extract_number_from_text(to_text, default=100)
            
            # Ð˜Ñ‰ÐµÐ¼ "Ð¾Ñ‚ X"
            from_match = re.search(r'Ð¾Ñ‚\s+([Ð°-ÑÑ‘\d\s]+)', cmd)
            if from_match:
                from_text = from_match.group(1).strip()
                min_val = self._extract_number_from_text(from_text, default=1)
            
            # Ð•ÑÐ»Ð¸ Ð½Ðµ Ð½Ð°ÑˆÐ»Ð¸ ÑÐ²Ð½Ñ‹Ñ… ÑƒÐºÐ°Ð·Ð°Ð½Ð¸Ð¹, Ð¸Ñ‰ÐµÐ¼ Ð²ÑÐµ Ñ‡Ð¸ÑÐ»Ð° Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ
            if not from_match and not to_match:
                all_numbers = self._extract_all_numbers_from_text(cmd)
                if len(all_numbers) >= 1:
                    # Ð•ÑÐ»Ð¸ Ð½Ð°ÑˆÐ»Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð½Ð¾ Ñ‡Ð¸ÑÐ»Ð¾, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÐµÐ³Ð¾ ÐºÐ°Ðº Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ
                    max_val = all_numbers[0]
                    min_val = 1
        
        # ÐšÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½
        if min_val > max_val:
            min_val, max_val = max_val, min_val
        
        # ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·ÑƒÐ¼Ð½Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ
        min_val = max(0, min_val)
        max_val = min(1000000, max_val)
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ Ð½Ðµ Ð±Ñ‹Ð» ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ð¼
        if max_val - min_val > 10000:
            max_val = min_val + 10000
        
        # Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ñ‡Ð¸ÑÐ»Ð¾
        number = random.randint(min_val, max_val)
        
        # Ð—Ð²ÑƒÐº Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸
        sound = random.choice(["*Ð´ÑƒÐ¼Ð°ÑŽ*", "*Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÑŽ*", "*Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÑŽ*", "*Ð¿Ð¾Ð´Ð±Ð¸Ñ€Ð°ÑŽ*", "*Ð·Ð°Ð³Ð°Ð´Ñ‹Ð²Ð°ÑŽ*"])
        
        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚
        if min_val == 1 and max_val == 100:
            responses = [
                f"{sound} Ð¡Ð»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾: {number}! ðŸ”¢",
                f"{sound} Ð’Ð°ÑˆÐµ Ñ‡Ð¸ÑÐ»Ð¾: {number}!",
                f"{sound} Ð’Ñ‹Ð¿Ð°Ð»Ð¾ {number}!",
                f"{sound} Ð—Ð°Ð³Ð°Ð´Ñ‹Ð²Ð°ÑŽ... {number}!"
            ]
        else:
            responses = [
                f"{sound} Ð¡Ð»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾ Ð¾Ñ‚ {min_val} Ð´Ð¾ {max_val}: {number}! ðŸ”¢",
                f"{sound} Ð’ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ðµ {min_val}-{max_val} Ð²Ñ‹Ð¿Ð°Ð»Ð¾ {number}!",
                f"{sound} Ð’Ð°ÑˆÐµ Ñ‡Ð¸ÑÐ»Ð¾: {number} (Ð¾Ñ‚ {min_val} Ð´Ð¾ {max_val})",
                f"{sound} ÐœÐµÐ¶Ð´Ñƒ {min_val} Ð¸ {max_val} Ñ Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÑŽ {number}!",
                f"{sound} Ð˜Ð· {min_val} Ð² {max_val} Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÑ‚ÑÑ {number}!"
            ]
        
        return random.choice(responses)
    
    def _extract_number_from_text(self, text: str, default: int = None) -> int:
        """
        Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÑ‚ Ñ‡Ð¸ÑÐ»Ð¾ Ð¸Ð· Ñ‚ÐµÐºÑÑ‚Ð° (Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ Ñ†Ð¸Ñ„Ñ€Ñ‹ Ð¸ ÑÐ»Ð¾Ð²Ð°)
        
        Args:
            text: Ð¢ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
            default: Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
            
        Returns:
            int: Ð Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ð½Ð½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾ Ð¸Ð»Ð¸ default ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ñ€Ð°ÑÐ¿Ð¾Ð·Ð½Ð°Ñ‚ÑŒ
        """
        if not text:
            return default
        
        text = text.lower().strip()
        
        # 1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð»Ð¸ Ñ‚ÐµÐºÑÑ‚ Ñ‡Ð¸ÑÐ»Ð¾Ð¼
        if text.isdigit():
            return int(text)
        
        # 2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ Ñ‡Ð¸ÑÐµÐ» (ÑÐ½Ð°Ñ‡Ð°Ð»Ð° ÑÐ¾ÑÑ‚Ð°Ð²Ð½Ñ‹Ðµ, Ð¿Ð¾Ñ‚Ð¾Ð¼ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ðµ)
        # Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ Ð´Ð»Ð¸Ð½Ðµ (ÑÐ°Ð¼Ñ‹Ðµ Ð´Ð»Ð¸Ð½Ð½Ñ‹Ðµ ÑÐ½Ð°Ñ‡Ð°Ð»Ð°)
        for number_text in sorted(self.number_dict.keys(), key=len, reverse=True):
            if number_text in text:
                return self.number_dict[number_text]
        
        # 3. ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð½Ð°Ð¹Ñ‚Ð¸ Ñ†Ð¸Ñ„Ñ€Ñ‹ Ð² Ñ‚ÐµÐºÑÑ‚Ðµ
        digits_match = re.search(r'\d+', text)
        if digits_match:
            return int(digits_match.group())
        
        # 4. ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐ¸Ñ‚ÑŒ ÑÐ¾ÑÑ‚Ð°Ð²Ð½Ñ‹Ðµ Ñ‡Ð¸ÑÐ»Ð° Ñ‚Ð¸Ð¿Ð° "Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ Ð¿ÑÑ‚ÑŒ"
        # Ð Ð°Ð·Ð±Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð½Ð° ÑÐ»Ð¾Ð²Ð° Ð¸ Ð¿Ñ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÑÐ¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾
        words = text.split()
        total = 0
        current = 0
        
        for word in words:
            if word in self.number_dict:
                value = self.number_dict[word]
                if value >= 100:
                    if current > 0:
                        total += current
                        current = 0
                    total += value
                elif value >= 10:
                    if current > 0:
                        total += current
                    current = value
                else:
                    current += value
        
        total += current
        
        if total > 0:
            return total
        
        return default
    
    def _extract_all_numbers_from_text(self, text: str) -> list:
        """
        Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÑ‚ Ð²ÑÐµ Ñ‡Ð¸ÑÐ»Ð° Ð¸Ð· Ñ‚ÐµÐºÑÑ‚Ð°
        
        Args:
            text: Ð¢ÐµÐºÑÑ‚ Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
            
        Returns:
            list: Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ñ… Ñ‡Ð¸ÑÐµÐ»
        """
        numbers = []
        text_lower = text.lower()
        
        # 1. Ð˜Ñ‰ÐµÐ¼ Ñ†Ð¸Ñ„Ñ€Ð¾Ð²Ñ‹Ðµ Ñ‡Ð¸ÑÐ»Ð°
        for match in re.finditer(r'\d+', text_lower):
            numbers.append(int(match.group()))
        
        # 2. Ð˜Ñ‰ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ñ‡Ð¸ÑÐ»Ð°
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð¿Ð¸ÑŽ Ñ‚ÐµÐºÑÑ‚Ð° Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ°
        search_text = text_lower
        
        # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑƒÐ¶Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ Ñ†Ð¸Ñ„Ñ€Ñ‹ Ð¸Ð· Ð¿Ð¾Ð¸ÑÐºÐ°
        for num in numbers[:]:
            search_text = search_text.replace(str(num), '')
        
        # Ð˜Ñ‰ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ðµ Ñ‡Ð¸ÑÐ»Ð° Ð² Ð¾ÑÑ‚Ð°Ð²ÑˆÐµÐ¼ÑÑ Ñ‚ÐµÐºÑÑ‚Ðµ
        # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° ÑÐ°Ð¼Ñ‹Ðµ Ð´Ð»Ð¸Ð½Ð½Ñ‹Ðµ (ÑÐ¾ÑÑ‚Ð°Ð²Ð½Ñ‹Ðµ)
        sorted_numbers = sorted(self.number_dict.keys(), key=len, reverse=True)
        
        for number_text in sorted_numbers:
            if number_text in search_text and self.number_dict[number_text] not in numbers:
                numbers.append(self.number_dict[number_text])
                # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð½Ð°Ð¹Ð´ÐµÐ½Ð½Ð¾Ðµ ÑÐ»Ð¾Ð²Ð¾ Ð¸Ð· Ñ‚ÐµÐºÑÑ‚Ð°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ ÐµÐ³Ð¾ Ñ‡Ð°ÑÑ‚Ð¸
                search_text = search_text.replace(number_text, '')
        
        return numbers
    
    def _text_to_number(self, text: str) -> int:
        """
        ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ðµ Ð¿Ñ€ÐµÐ´ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‡Ð¸ÑÐ»Ð° Ð² Ñ‡Ð¸ÑÐ»Ð¾Ð²Ð¾Ðµ
        
        Args:
            text: Ð¢ÐµÐºÑÑ‚ Ð´Ð»Ñ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð°Ñ†Ð¸Ð¸
            
        Returns:
            int: Ð§Ð¸ÑÐ»Ð¾Ð²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
        """
        # Ð­Ñ‚Ð¾ ÑƒÐ¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ñ… ÑÐ»ÑƒÑ‡Ð°ÐµÐ²
        text = text.lower().strip()
        
        if text.isdigit():
            return int(text)
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ
        if text in self.number_dict:
            return self.number_dict[text]
        
        # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ñ€Ð°ÑÐ¿Ð°Ñ€ÑÐ¸Ñ‚ÑŒ ÑÐ¾ÑÑ‚Ð°Ð²Ð½Ñ‹Ðµ Ñ‡Ð¸ÑÐ»Ð°
        if ' ' in text:
            parts = text.split()
            total = 0
            for part in parts:
                if part in self.number_dict:
                    total += self.number_dict[part]
            return total if total > 0 else None
        
        return None