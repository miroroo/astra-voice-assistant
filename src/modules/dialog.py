import random
from .module import Module

class DialogModule(Module):
    """Модуль для диалогового взаимодействия с пользователем."""
    
    def __init__(self, astra_manager):
        super().__init__(astra_manager)
        
        # Ключевые слова для определения возможности обработки
        self.dialog_keywords = [
            # Приветствия
            'привет', 'здравствуй', 'здравствуйте',
            'добрый день', 'доброе утро', 'добрый вечер',
            'хай', 'здорово', 'приветствую', 'салют',
            
            # Вопросы о делах
            'как дела', 'как ты', 'как поживаешь',
            'что нового', 'как у тебя дела', 'как твои дела',
            'как жизнь', 'как сам', 'как оно',
            
            # Вопросы о настроении
            'как настроение', 'как самочувствие',
            'как себя чувствуешь', 'какое настроение',
            
            # Благодарности
            'спасибо', 'благодарю', 'спс', 'мерси',
            'спасибо большое', 'большое спасибо',
            
            # Похвалы
            'молодец', 'умница', 'хорошая работа',
            'отлично', 'умничка', 'красавчик',
            'супер', 'класс', 'здорово',
            'прекрасно', 'замечательно',
            
            # Прощания
            'пока', 'до свидания', 'до встречи',
            'всего хорошего', 'прощай', 'увидимся',

            # ответы
            'хорошо', 'плохо', 'нормально', 'потихоньку',
            'хорошее', 'плохое', 'нормальное', 
        ]
        
        # Инициализация компонентов Astra
        self.module_name = self.get_name()
        self.state_manager = self.astra_manager.get_state_manager()
    
    async def can_handle(self, command: str) -> bool:
        """
        Проверяет, может ли модуль обработать команду
        
        Args:
            command: Текст команды от пользователя
            
        Returns:
            bool: True если встречаются ключевые слова, иначе False
        """
        
        # Проверяем каждое ключевое слово
        for keyword in self.dialog_keywords:
            if keyword in command:
                # Устанавливаем активный контекст для модуля
                self.state_manager.set_active_context(
                    self.module_name,
                    priority=10,  # Средний приоритет для диалоговых команд
                    context_type="dialog",
                    timeout_seconds=120  # 2 минуты
                )
                return True
        
        return False
    
    async def execute(self, command: str) -> str:
        """
        Обрабатывает команду и возвращает ответ
        
        Args:
            command: Текст команды от пользователя
            
        Returns:
            str: Ответ модуля на команду
        """
        # Приводим команду к нижнему регистру для сравнения
        cmd = command.lower()
        
        # Определяем тип команды и возвращаем соответствующий ответ
        if any(word in cmd for word in ['привет', 'здравствуй', 'здравствуйте', 'добрый', 'доброе']):
            return random.choice([
                "Привет! Рада тебя слышать!",
                "Здравствуй! Как дела?",
                "Приветствую! Как настроение?",
                "Привет! Что нового?",
                "Здорово! Как ты?"
            ])
        
        elif any(word in cmd for word in ['как дела', 'как ты', 'как жизнь']):
            return random.choice([
                "У меня всё отлично, спасибо! А как твои дела?",
                "Всё прекрасно! А ты как?",
                "Всё хорошо! Как у тебя дела?",
                "Работаю как часы! Как ты поживаешь?"
            ])
        
        elif any(word in cmd for word in ['как настроение', 'как самочувствие']):
            return random.choice([
                "У меня всегда отличное настроение! А какое у тебя?",
                "Настроение прекрасное! А у тебя как?",
                "Я всегда в хорошем расположении духа! Как твоё настроение?"
            ])
        
        elif any(word in cmd for word in ['спасибо', 'благодарю']):
            return random.choice([
                "Пожалуйста! Всегда рада помочь!",
                "Не за что! Обращайся!",
                "Рада была помочь!",
                "Всегда пожалуйста!"
            ])
        
        elif any(word in cmd for word in ['молодец', 'умница', 'хорошая работа']):
            return random.choice([
                "Спасибо за добрые слова!",
                "Очень приятно это слышать!",
                "Благодарю! Стараюсь быть полезной!",
                "Спасибо! Рада, что понравилось!"
            ])
        
        elif any(word in cmd for word in ['пока', 'до свидания', 'прощай']):
            return random.choice([
                "До свидания! Было приятно пообщаться!",
                "Пока! Жду нашей следующей встречи!",
                "До встречи! Хорошего дня!",
                "Пока-пока! Всего доброго!"
            ])
        
        elif any(word in cmd for word in ['хорошо', 'плохо', 'нормально', 'потихоньку',
            'хорошее', 'плохое', 'нормальное',]):
            return random.choice([
                "Оставайся на связи!",
            ])